<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Network æ±ºæ¸ˆãƒ‡ãƒ¢
  - ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 500px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h2 i {
            font-size: 24px;
        }
        
        .product-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .product-card h3 {
            color: #17a2b8;
            margin-bottom: 10px;
        }
        
        .price {
            font-size: 32px;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            margin: 10px 0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .hidden {
            display: none;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .payment-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 12px;
            border-top: 1px solid #e9ecef;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #17a2b8;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .badge.testnet {
            background: #ffc107;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pi Network æ±ºæ¸ˆãƒ‡ãƒ¢ <span class="badge testnet">TESTNET</span></h1>
            <p>pi-app-id: testnet_dummy_app_001</p>
        </div>
        
        <div class="content">
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section" id="loginSection">
                <h2><i>ğŸ”</i> ã‚¹ãƒ†ãƒƒãƒ—1: Pi Network ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <p>Piã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã—ã¦èªè¨¼ã‚’è¡Œã£ã¦ãã ã•ã„</p>
                
                <div id="loginStatus" class="status-box status-info">
                    Pi Network Testnetã«æ¥ç¶šã™ã‚‹æº–å‚™ãŒã§ãã¦ã„ã¾ã™
                </div>
                
                <button id="loginBtn" class="btn btn-primary" onclick="authenticate()">
                    <span id="loginText">Piã§ãƒ­ã‚°ã‚¤ãƒ³</span>
                    <span id="loginLoader" class="loader hidden"></span>
                </button>
            </div>
            
            <!-- æ±ºæ¸ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section hidden" id="paymentSection">
                <h2><i>ğŸ›’</i> ã‚¹ãƒ†ãƒƒãƒ—2: å•†å“é¸æŠ</h2>
                
                <div class="product-card">
                    <h3>ãƒ‡ã‚¸ã‚¿ãƒ«å•†å“ãƒ‘ãƒƒã‚¯</h3>
                    <p>ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ã‚¸ã‚¿ãƒ«å•†å“ã§ã™</p>
                    <div class="price">1 Ï€</div>
                    <p>å•†å“ID: DIGITAL_001</p>
                </div>
                
                <div class="product-card">
                    <h3>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ©Ÿèƒ½</h3>
                    <p>è¿½åŠ æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆç”¨</p>
                    <div class="price">5 Ï€</div>
                    <p>å•†å“ID: PREMIUM_001</p>
                </div>
                
                <div>
                    <label for="amountInput">ã‚«ã‚¹ã‚¿ãƒ é‡‘é¡ (Ï€):</label>
                    <input type="number" id="amountInput" min="0.1" max="100" step="0.1" value="1" 
                           style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div>
                    <label for="memoInput">ãƒ¡ãƒ¢ (ä»»æ„):</label>
                    <input type="text" id="memoInput" placeholder="è³¼å…¥å†…å®¹ã®ãƒ¡ãƒ¢"
                           style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                
                <div id="paymentStatus" class="status-box status-info">
                    é‡‘é¡ã‚’é¸æŠã—ã¦æ±ºæ¸ˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                </div>
                
                <button id="paymentBtn" class="btn btn-success" onclick="createPayment()">
                    <span id="paymentText">æ±ºæ¸ˆã‚’å®Ÿè¡Œ</span>
                    <span id="paymentLoader" class="loader hidden"></span>
                </button>
            </div>
            
            <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section hidden" id="resultSection">
                <h2><i>âœ…</i> ã‚¹ãƒ†ãƒƒãƒ—3: æ±ºæ¸ˆå®Œäº†</h2>
                
                <div id="resultStatus" class="status-box status-success">
                    æ±ºæ¸ˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼
                </div>
                
                <div id="resultDetails" class="payment-details">
                    <!-- æ±ºæ¸ˆè©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                
                <button class="btn btn-secondary" onclick="resetApp()">æ–°ã—ã„æ±ºæ¸ˆã‚’é–‹å§‹</button>
                <button class="btn btn-primary" onclick="viewTransaction()" style="margin-top: 10px;">
                    ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
                </button>
            </div>
            
            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
            <div class="section" id="debugSection">
                <h2><i>ğŸ›</i> ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
                <div id="debugInfo" class="payment-details">
                    ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
                <button class="btn btn-secondary" onclick="clearDebug()" style="margin-top: 10px;">
                    ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
        
        <div class="footer">
            <p>âš ï¸ ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆç”¨ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã§ã™ã€‚å®Ÿéš›ã®Piã¯ä½¿ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚</p>
            <p>Pi Network Testnet | Version 1.0.0</p>
        </div>
    </div>

    <!-- PiSDKã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
        // ====================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ====================
        let pi = null;
        let currentUser = null;
        let currentPayment = null;
        let sessionData = {
            startTime: new Date().toISOString(),
            payments: [],
            logs: []
        };

        // ====================
        // ãƒ­ã‚°é–¢æ•°
        // ====================
        function addLog(message, data = null) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                message: message,
                data: data
            };
            
            sessionData.logs.push(logEntry);
            updateDebugInfo();
            
            console.log(`[PiSDK] ${message}`, data || '');
        }

        // ====================
        // åˆæœŸåŒ–é–¢æ•°
        // ====================
        function initializePiSDK() {
            try {
                addLog('PiSDKåˆæœŸåŒ–é–‹å§‹');
                
                pi = new window.Pi({
                    sandbox: true, // Testnetãƒ¢ãƒ¼ãƒ‰
                    version: "2.0"
                });
                
                addLog('PiSDKåˆæœŸåŒ–å®Œäº†', { sandbox: true, version: "2.0" });
                updateStatus('loginStatus', 'PiSDKã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ', 'info');
                
            } catch (error) {
                addLog('PiSDKåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', error);
                updateStatus('loginStatus', `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ====================
        // èªè¨¼é–¢æ•°
        // ====================
        async function authenticate() {
            if (!pi) {
                updateStatus('loginStatus', 'PiSDKãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // UIæ›´æ–°
                showLoader('login');
                updateStatus('loginStatus', 'Pi Networkã«æ¥ç¶šä¸­...', 'info');
                
                // ã‚¹ã‚³ãƒ¼ãƒ—è¨­å®š
                const scopes = ['username', 'payments', 'wallet_address'];
                
                addLog('èªè¨¼é–‹å§‹', { scopes: scopes });
                
                // PiSDKèªè¨¼å®Ÿè¡Œ
                const user = await pi.authenticate(scopes, onIncompletePaymentFound);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜
                currentUser = {
                    uid: user.uid,
                    username: user.username,
                    walletAddress: user.walletAddress || 'N/A'
                };
                
                addLog('èªè¨¼æˆåŠŸ', currentUser);
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                updateStatus('loginStatus', 
                    `âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼<br>
                    ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.username}<br>
                    ğŸ†” UID: ${user.uid.substring(0, 8)}...<br>
                    ğŸ’³ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ: ${user.walletAddress ? user.walletAddress.substring(0, 10) + '...' : 'N/A'}`, 
                    'success'
                );
                
                // æ±ºæ¸ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
                document.getElementById('loginSection').style.opacity = '0.6';
                document.getElementById('paymentSection').classList.remove('hidden');
                
                hideLoader('login');
                
            } catch (error) {
                addLog('èªè¨¼ã‚¨ãƒ©ãƒ¼', error);
                updateStatus('loginStatus', 
                    `âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}`, 
                    'error'
                );
                hideLoader('login');
            }
        }

        // ====================
        // æœªå®Œäº†æ±ºæ¸ˆå‡¦ç†
        // ====================
        function onIncompletePaymentFound(payment) {
            addLog('æœªå®Œäº†æ±ºæ¸ˆã‚’æ¤œå‡º', payment);
            
            updateStatus('paymentStatus', 
                `æœªå®Œäº†ã®æ±ºæ¸ˆãŒã‚ã‚Šã¾ã™: ${payment.identifier}<br>
                å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™...`, 
                'warning'
            );
            
            // è‡ªå‹•çš„ã«å®Œäº†å‡¦ç†ã‚’è©¦ã¿ã‚‹
            return pi.completePayment(payment);
        }

        // ====================
        // æ±ºæ¸ˆä½œæˆé–¢æ•°
        // ====================
        async function createPayment() {
            if (!currentUser || !pi) {
                updateStatus('paymentStatus', 'å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                // å…¥åŠ›å€¤å–å¾—
                const amount = parseFloat(document.getElementById('amountInput').value) || 1;
                const memo = document.getElementById('memoInput').value || 
                            `ãƒ†ã‚¹ãƒˆè³¼å…¥
  - ${new Date().toLocaleString()}`;
                
                if (amount <= 0) {
                    updateStatus('paymentStatus', 'æœ‰åŠ¹ãªé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                // UIæ›´æ–°
                showLoader('payment');
                updateStatus('paymentStatus', 'æ±ºæ¸ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆä¸­...', 'info');
                
                // æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿
                const paymentData = {
                    amount: amount,
                    memo: memo,
                    metadata: {
                        productId: amount >= 5 ? "PREMIUM_001" : "DIGITAL_001",
                        userId: currentUser.uid,
                        appId: "testnet_dummy_app_001",
                        timestamp: new Date().toISOString(),
                        environment: "testnet"
                    }
                };
                
                addLog('æ±ºæ¸ˆä½œæˆé–‹å§‹', paymentData);
                
                // æ±ºæ¸ˆä½œæˆ
                const payment = await pi.createPayment(paymentData);
                currentPayment = payment;
                
                addLog('æ±ºæ¸ˆä½œæˆæˆåŠŸ', payment);
                
                updateStatus('paymentStatus', 
                    `âœ… æ±ºæ¸ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆå®Œäº†ï¼<br>
                    ğŸ’° é‡‘é¡: ${amount} Ï€<br>
                    ğŸ†” æ±ºæ¸ˆID: ${payment.identifier}<br>
                    <small>Piã‚¢ãƒ—ãƒªã§æ‰¿èªã‚’å®Œäº†ã—ã¦ãã ã•ã„</small>`, 
                    'success'
                );
                
                // æ±ºæ¸ˆå®Œäº†ã‚’ç›£è¦–
                monitorPayment(payment.identifier);
                
                hideLoader('payment');
                
            } catch (error) {
                addLog('æ±ºæ¸ˆä½œæˆã‚¨ãƒ©ãƒ¼', error);
                updateStatus('paymentStatus', 
                    `âŒ æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼: ${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 
                    'error'
                );
                hideLoader('payment');
            }
        }

        // ====================
        // æ±ºæ¸ˆç›£è¦–é–¢æ•°
        // ====================
        async function monitorPayment(paymentId) {
            addLog('æ±ºæ¸ˆç›£è¦–é–‹å§‹', { paymentId: paymentId });
            
            updateStatus('paymentStatus', 
                'â³ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰¿èªã‚’å¾…ã£ã¦ã„ã¾ã™...<br><small>Piã‚¢ãƒ—ãƒªã§æ±ºæ¸ˆã‚’æ‰¿èªã—ã¦ãã ã•ã„</small>', 
                'warning'
            );
            
            try {
                // æ±ºæ¸ˆå®Œäº†ã‚’å¾…æ©Ÿ
                const approvedPayment = await pi.waitForPayment(paymentId, {
                    onReadyForServerCompletion: async (paymentId) => {
                        addLog('ã‚µãƒ¼ãƒãƒ¼å®Œäº†å‡¦ç†é–‹å§‹', { paymentId: paymentId });
                        
                        // ã‚µãƒ¼ãƒãƒ¼å‡¦ç†å®Ÿè¡Œ
                        const serverResult = await completePaymentOnServer(paymentId);
                        
                        if (serverResult.success) {
                            addLog('ã‚µãƒ¼ãƒãƒ¼å‡¦ç†æˆåŠŸ', serverResult);
                            return { success: true };
                        } else {
                            addLog('ã‚µãƒ¼ãƒãƒ¼å‡¦ç†å¤±æ•—', serverResult);
                            return { success: false, error: serverResult.error };
                        }
                    }
                });
                
                // æ±ºæ¸ˆå®Œäº†å‡¦ç†
                await handlePaymentCompletion(approvedPayment);
                
            } catch (error) {
                addLog('æ±ºæ¸ˆç›£è¦–ã‚¨ãƒ©ãƒ¼', error);
                updateStatus('paymentStatus', 
                    `âŒ æ±ºæ¸ˆç›£è¦–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 
                    'error'
                );
            }
        }

        // ====================
        // ã‚µãƒ¼ãƒãƒ¼å®Œäº†å‡¦ç†
        // ====================
        async function completePaymentOnServer(paymentId) {
            try {
                updateStatus('paymentStatus', 'ğŸ”„ ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’å®Ÿè¡Œä¸­...', 'info');
                
                // Herokuã®Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—
                const response = await fetch('/webhook.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentId: paymentId,
                        action: 'complete',
                        user: currentUser,
                        timestamp: new Date().toISOString(),
                        appId: 'testnet_dummy_app_001'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('ã‚µãƒ¼ãƒãƒ¼å‡¦ç†æˆåŠŸ', result);
                    updateStatus('paymentStatus', 'âœ… ã‚µãƒ¼ãƒãƒ¼å‡¦ç†å®Œäº†', 'success');
                    return { success: true, data: result };
                } else {
                    throw new Error(result.error || 'ã‚µãƒ¼ãƒãƒ¼å‡¦ç†å¤±æ•—');
                }
                
            } catch (error) {
                addLog('ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
                return { 
                    success: false, 
                    error: error.message,
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œäº†å‡¦ç†
                    fallback: true
                };
            }
        }
        // ====================
        // æ±ºæ¸ˆå®Œäº†å‡¦ç†
        // ====================
        async function handlePaymentCompletion(payment) {
            try {
                addLog('æ±ºæ¸ˆå®Œäº†å‡¦ç†é–‹å§‹', payment);
                
                // æ±ºæ¸ˆæƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
                sessionData.payments.push({
                    id: payment.identifier,
                    amount: payment.amount,
                    status: payment.status,
                    timestamp: new Date().toISOString(),
                    user: currentUser.uid
                });
                
                // çµæœè¡¨ç¤º
                showPaymentResult(payment);
                
                addLog('æ±ºæ¸ˆå®Œäº†', payment);
                
            } catch (error) {
                addLog('æ±ºæ¸ˆå®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
                updateStatus('paymentStatus', 
                    `âŒ å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`, 
                    'error'
                );
            }
        }

        // ====================
        // æ±ºæ¸ˆçµæœè¡¨ç¤º
        // ====================
        function showPaymentResult(payment) {
            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            // è©³ç´°æƒ…å ±ä½œæˆ
            const details = `
                <strong>ğŸ‰ æ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸï¼</strong>
                <br><br>
                <strong>æ±ºæ¸ˆID:</strong> ${payment.identifier}
                <br>
                <strong>é‡‘é¡:</strong> ${payment.amount} Ï€
                <br>
                <strong>çŠ¶æ…‹:</strong> ${payment.status}
                <br>
                <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> ${currentUser.username}
                <br>
                <strong>UID:</strong> ${currentUser.uid.substring(0, 12)}...
                <br>
                <strong>å®Œäº†æ—¥æ™‚:</strong> ${new Date().toLocaleString()}
                <br><br>
                <small>â€» ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã§ã®å–å¼•ã§ã™</small>
            `;
            
            document.getElementById('resultDetails').innerHTML = details;
            
            updateStatus('resultStatus', 
                'âœ… æ±ºæ¸ˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼<br><small>ãƒ‡ã‚¸ã‚¿ãƒ«å•†å“ãŒæä¾›ã•ã‚Œã¾ã—ãŸ</small>', 
                'success'
            );
        }

        // ====================
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        // ====================
        function viewTransaction() {
            if (!currentPayment) {
                alert('æ±ºæ¸ˆæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const txDetails = `
                <strong>å–å¼•è©³ç´°:</strong>
                <br><br>
                <strong>æ±ºæ¸ˆID:</strong> ${currentPayment.identifier}
                <br>
                <strong>é‡‘é¡:</strong> ${currentPayment.amount} Ï€
                <br>
                <strong>ãƒ¡ãƒ¢:</strong> ${currentPayment.memo || 'N/A'}
                <br>
                <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼UID:</strong> ${currentUser.uid}
                <br>
                <strong>ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—:</strong> ${new Date().toISOString()}
                <br><br>
                <strong>ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆURL:</strong>
                <br>
                <a href="https://testnet.minepi.com" target="_blank">
                    https://testnet.minepi.com
                </a>
            `;
            
            document.getElementById('resultDetails').innerHTML = txDetails;
        }

        // ====================
        // ã‚¢ãƒ—ãƒªãƒªã‚»ãƒƒãƒˆ
        // ====================
        function resetApp() {
            addLog('ã‚¢ãƒ—ãƒªãƒªã‚»ãƒƒãƒˆ');
            
            // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
            document.getElementById('loginSection').style.opacity = '1';
            document.getElementById('paymentSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            
            // å…¥åŠ›å€¤ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('amountInput').value = '1';
            document.getElementById('memoInput').value = '';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆ
            updateStatus('loginStatus', 'æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
            updateStatus('paymentStatus', 'é‡‘é¡ã‚’é¸æŠã—ã¦æ±ºæ¸ˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿æŒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            // currentUser = null;
            // currentPayment = null;
        }

        // ====================
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        // ====================
        function updateDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            
            const info = `
                <strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±:</strong>
                <br>é–‹å§‹: ${new Date(sessionData.startTime).toLocaleString()}
                <br>ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser ? currentUser.username : 'æœªãƒ­ã‚°ã‚¤ãƒ³'}
                <br>æ±ºæ¸ˆå›æ•°: ${sessionData.payments.length}
                <br>ãƒ­ã‚°æ•°: ${sessionData.logs.length}
                <br><br>
                <strong>æœ€æ–°ãƒ­ã‚°:</strong>
                ${sessionData.logs.slice(-3).map(log => 
                    `<br>${new Date(log.timestamp).toLocaleTimeString()}: ${log.message}`
                ).join('')}
            `;
            
            debugDiv.innerHTML = info;
        }

        // ====================
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚¯ãƒªã‚¢
        // ====================
        function clearDebug() {
            sessionData.logs = [];
            updateDebugInfo();
            addLog('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // ====================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ====================
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status-box status-${type}`;
        }

        function showLoader(type) {
            document.getElementById(`${type}Loader`).classList.remove('hidden');
            document.getElementById(`${type}Text`).style.opacity = '0.5';
        }

        function hideLoader(type) {
            document.getElementById(`${type}Loader`).classList.add('hidden');
            document.getElementById(`${type}Text`).style.opacity = '1';
        }

        // ====================
        // åˆæœŸåŒ–
        // ====================
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•');
            initializePiSDK();
            updateDebugInfo();
        });
    </script>
</body>
</html>
